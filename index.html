<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Server PRO Client (Advanced, Vercel Ready)</title>
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --error-color: #dc3545;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: #333;
            text-align: right;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            border-right: 5px solid var(--primary-color);
        }
        .card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        .card p {
            font-size: 0.9em;
            color: #6c757d;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], textarea, button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ced4da;
            box-sizing: border-box;
            font-size: 1em;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .response-box {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: left; /* للحفاظ على تنسيق الـ JSON */
        }
        .success {
            background-color: #d4edda;
            color: var(--success-color);
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: var(--error-color);
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            text-align: center;
        }
        .note {
            background-color: #e2e6ea;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-right: 3px solid #6c757d;
            font-size: 0.9em;
        }
        .supabase-info {
            font-size: 0.8em;
            color: #495057;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>واجهة عميل PDF Server PRO (متوافقة مع Vercel و Supabase)</h1>

        <div class="note">
            <p>**ملاحظات هامة:**</p>
            <ul>
                <li>**رابط السيرفر المستخدم هو:** <code style="color: var(--primary-color);">https://pdf-server-navy.vercel.app/</code></li>
                <li>كل الروابط والثوابت الخاصة بـ Supabase موجودة ثابتة ومدمجة في كود السيرفر ولا تحتاج لإرسالها.</li>
                <li>رابط ملف PDF افتراضي للاختبار: <code style="direction: ltr;">https://pdf-lib.org/assets/acrobat.pdf</code></li>
            </ul>
        </div>

        <div class="grid">

            <div class="card" data-endpoint="health">
                <h3>فحص حالة السيرفر</h3>
                <p>يتحقق من أن السيرفر يعمل بشكل صحيح ويسجل Log في Supabase.</p>
                <button onclick="sendRequest('health')">فحص الحالة</button>
                <div id="health-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="compress">
                <h3>ضغط PDF (مع رفع Supabase)</h3>
                <p>يقلل حجم ملف PDF ويرفعه للـ Storage.</p>
                <label for="compress-url">رابط الملف العام (publicUrl)</label>
                <input type="text" id="compress-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <button onclick="sendRequest('compress')">تنفيذ الضغط</button>
                <div id="compress-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="merge">
                <h3>دمج PDF (مع رفع Supabase)</h3>
                <p>يدمج عدة ملفات (روابط مفصولة بسطر جديد).</p>
                <label for="merge-urls">روابط الملفات العامة (publicUrls)</label>
                <textarea id="merge-urls" rows="3" placeholder="http://file1.pdf&#10;http://file2.pdf">https://pdf-lib.org/assets/acrobat.pdf&#10;https://pdf-lib.org/assets/acrobat.pdf</textarea>
                <button onclick="sendRequest('merge')">تنفيذ الدمج</button>
                <div id="merge-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="extract-pages">
                <h3>استخراج صفحات (مع رفع Supabase)</h3>
                <p>استخراج صفحات محددة (مثال: 1,3-5).</p>
                <label for="extract-pages-url">رابط الملف العام</label>
                <input type="text" id="extract-pages-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <label for="extract-pages-list">الصفحات</label>
                <input type="text" id="extract-pages-list" placeholder="1,2,5-7" value="1-2">
                <button onclick="sendRequest('extract-pages')">تنفيذ الاستخراج</button>
                <div id="extract-pages-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="extract-text">
                <h3>استخراج النصوص (JSON)</h3>
                <p>استخلاص جميع النصوص والميتاداتا من الملف.</p>
                <label for="extract-text-url">رابط الملف العام</label>
                <input type="text" id="extract-text-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <button onclick="sendRequest('extract-text')">تنفيذ استخراج النص</button>
                <div id="extract-text-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="info">
                <h3>معلومات الملف (JSON)</h3>
                <p>الحصول على عدد الصفحات والحجم بالبايت والميجا.</p>
                <label for="info-url">رابط الملف العام</label>
                <input type="text" id="info-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <button onclick="sendRequest('info')">تنفيذ الاستعلام</button>
                <div id="info-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="protect">
                <h3>حماية منطقية (مع رفع Supabase)</h3>
                <p>إضافة صفحة تحذير وكلمة مرور في الميتاداتا.</p>
                <label for="protect-url">رابط الملف العام</label>
                <input type="text" id="protect-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <label for="protect-password">كلمة المرور</label>
                <input type="text" id="protect-password" value="secret123">
                <button onclick="sendRequest('protect')">تنفيذ الحماية</button>
                <div id="protect-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="unlock">
                <h3>إلغاء الحماية (مع رفع Supabase)</h3>
                <p>إزالة صفحة التحذير الأولى وتنظيف الميتاداتا.</p>
                <label for="unlock-url">رابط الملف العام</label>
                <input type="text" id="unlock-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <button onclick="sendRequest('unlock')">تنفيذ الإلغاء</button>
                <div id="unlock-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="watermark-text">
                <h3>علامة مائية (نص) - مع رفع Supabase</h3>
                <p>إضافة علامة مائية نصية مائلة على كل الصفحات.</p>
                <label for="watermark-url">رابط الملف العام</label>
                <input type="text" id="watermark-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <label for="watermark-text">النص</label>
                <input type="text" id="watermark-text" value="CONFIDENTIAL">
                <label for="watermark-opacity">الشفافية (0.1-1.0)</label>
                <input type="number" id="watermark-opacity" step="0.1" min="0.1" max="1.0" value="0.2">
                <button onclick="sendRequest('watermark-text')">تنفيذ العلامة المائية</button>
                <div id="watermark-text-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="rotate-pages">
                <h3>تدوير الصفحات (مع رفع Supabase)</h3>
                <p>تدوير صفحات محددة بزاوية (90, 180, 270).</p>
                <label for="rotate-url">رابط الملف العام</label>
                <input type="text" id="rotate-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <label for="rotate-angle">الزاوية (بالدرجات)</label>
                <input type="number" id="rotate-angle" value="90">
                <label for="rotate-pages-list">الصفحات (اختياري، مثل: 1,3)</label>
                <input type="text" id="rotate-pages-list" placeholder="اتركها فارغة للكل">
                <button onclick="sendRequest('rotate-pages')">تنفيذ التدوير</button>
                <div id="rotate-pages-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="reorder-pages">
                <h3>إعادة ترتيب الصفحات (مع رفع Supabase)</h3>
                <p>تحديد ترتيب الصفحات الجديد (مثال: 3,1,2).</p>
                <label for="reorder-url">رابط الملف العام</label>
                <input type="text" id="reorder-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <label for="reorder-order">الترتيب الجديد (مثال: 3,1,2)</label>
                <input type="text" id="reorder-order" placeholder="ترتيب الصفحات" value="2,1">
                <button onclick="sendRequest('reorder-pages')">تنفيذ إعادة الترتيب</button>
                <div id="reorder-pages-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="metadata">
                <h3>تعديل الميتاداتا (مع رفع Supabase)</h3>
                <p>تغيير العنوان والمؤلف والموضوع.</p>
                <label for="metadata-url">رابط الملف العام</label>
                <input type="text" id="metadata-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <label for="metadata-title">العنوان</label>
                <input type="text" id="metadata-title" value="New PDF Title">
                <label for="metadata-author">المؤلف (اختياري)</label>
                <input type="text" id="metadata-author" value="Author Name">
                <button onclick="sendRequest('metadata')">تعديل الميتاداتا</button>
                <div id="metadata-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="extract-images">
                <h3>استخراج الصور (محاكاة ورفع Supabase)</h3>
                <p>محاكاة استخراج الصور ورفعها كـ PNGs إلى Supabase.</p>
                <label for="extract-images-url">رابط الملف العام</label>
                <input type="text" id="extract-images-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <button onclick="sendRequest('extract-images')">تنفيذ الاستخراج</button>
                <div id="extract-images-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="pdf-to-base64">
                <h3>PDF إلى Base64 (JSON)</h3>
                <p>تحويل الملف إلى سلسلة Base64 مشفرة.</p>
                <label for="pdf-to-base64-url">رابط الملف العام</label>
                <input type="text" id="pdf-to-base64-url" placeholder="http://..." value="https://pdf-lib.org/assets/acrobat.pdf">
                <button onclick="sendRequest('pdf-to-base64')">تحويل إلى Base64</button>
                <div id="pdf-to-base64-response" class="response-box"></div>
            </div>

            <div class="card" data-endpoint="base64-to-pdf">
                <h3>Base64 إلى PDF (رفع Supabase)</h3>
                <p>رفع ملف PDF إلى Supabase من بيانات Base64.</p>
                <label for="base64-file-name">اسم الملف النهائي (في Supabase)</label>
                <input type="text" id="base64-file-name" value="uploaded_from_base64_demo.pdf">
                <label for="base64-input">بيانات Base64 (لملف PDF صغير)</label>
                <textarea id="base64-input" rows="3" placeholder="أدخل سلسلة Base64 هنا..."></textarea>
                <button onclick="sendRequest('base64-to-pdf')">تحويل ورفع</button>
                <div id="base64-to-pdf-response" class="response-box"></div>
            </div>

        </div>
    </div>

    <script>
        // =========================================================
        //          *** الرابط الصحيح الذي قدمته الآن ***
        // =========================================================
        const SERVER_URL = 'https://pdf-server-navy.vercel.app'; 
        // =========================================================
        
        /**
         * دالة مساعدة لعرض النتائج والأخطاء
         */
        function displayResponse(endpoint, data, isError = false) {
            const responseBox = document.getElementById(`${endpoint}-response`);
            responseBox.className = 'response-box';
            if (isError) {
                responseBox.classList.add('error');
                const errorDetails = data.error || data.details || JSON.stringify(data, null, 2);
                responseBox.innerHTML = `**خطأ في العملية:**<br>${errorDetails}`;
            } else if (typeof data === 'string') {
                responseBox.classList.add('success');
                responseBox.innerHTML = data;
            } else {
                responseBox.classList.add('success');
                responseBox.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        }

        /**
         * دالة مساعدة لتحميل ملف PDF الناتج
         */
        function downloadFile(blob, filename, info = {}) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            
            let infoString = '';
            if (info.supabaseUrl) {
                infoString += `<br><br>✓ تم الرفع بنجاح إلى Supabase: <a href="${info.supabaseUrl}" target="_blank">${info.supabaseUrl}</a>`;
            }
            if (info.savedPercent) {
                infoString += `<br>حجم الملف الأصلي: ${info.originalMB}MB, الجديد: ${info.compressedMB}MB. التوفير: **${info.savedPercent}%**`;
            }

            return `تم تنفيذ العملية بنجاح! <br>تم تحميل الملف باسم **${filename}** في جهازك. ${infoString}`;
        }

        /**
         * الدالة الرئيسية لإرسال الطلبات
         */
        async function sendRequest(endpoint) {
            const responseBox = document.getElementById(`${endpoint}-response`);
            responseBox.className = 'response-box loading';
            responseBox.innerHTML = 'جاري المعالجة... يرجى الانتظار.';
            
            const url = `${SERVER_URL}/${endpoint}`;
            let payload = {};
            let isFileOperation = true; 
            let filename = `${endpoint}.pdf`;

            try {
                // تجميع البيانات حسب نقطة الوصول
                switch (endpoint) {
                    case 'compress':
                    case 'protect':
                    case 'unlock':
                    case 'extract-images':
                        payload.publicUrl = document.getElementById(`${endpoint}-url`).value;
                        filename = `output-${endpoint}.pdf`;
                        break;
                    
                    case 'extract-text':
                    case 'info':
                    case 'pdf-to-base64': // هذا يرجع JSON
                        payload.publicUrl = document.getElementById(`${endpoint}-url`).value;
                        isFileOperation = false;
                        break;
                        
                    case 'health':
                        isFileOperation = false; 
                        break;

                    case 'merge':
                        const urlsText = document.getElementById('merge-urls').value;
                        payload.publicUrls = urlsText.split('\n').map(u => u.trim()).filter(u => u);
                        filename = 'merged.pdf';
                        break;

                    case 'extract-pages':
                        payload.publicUrl = document.getElementById('extract-pages-url').value;
                        payload.pages = document.getElementById('extract-pages-list').value;
                        filename = 'extracted_pages.pdf';
                        break;
                        
                    case 'watermark-text':
                        payload.publicUrl = document.getElementById('watermark-url').value;
                        payload.text = document.getElementById('watermark-text').value;
                        payload.opacity = parseFloat(document.getElementById('watermark-opacity').value);
                        filename = 'watermarked.pdf';
                        break;

                    case 'rotate-pages':
                        payload.publicUrl = document.getElementById('rotate-url').value;
                        payload.angle = document.getElementById('rotate-angle').value;
                        payload.pages = document.getElementById('rotate-pages-list').value;
                        filename = 'rotated.pdf';
                        break;

                    case 'reorder-pages':
                        payload.publicUrl = document.getElementById('reorder-url').value;
                        payload.order = document.getElementById('reorder-order').value.split(',').map(n => parseInt(n.trim(), 10)).filter(n => !isNaN(n));
                        filename = 'reordered.pdf';
                        break;

                    case 'metadata':
                        payload.publicUrl = document.getElementById('metadata-url').value;
                        payload.title = document.getElementById('metadata-title').value;
                        payload.author = document.getElementById('metadata-author').value;
                        filename = 'metadata_updated.pdf';
                        break;
                        
                    case 'base64-to-pdf': // هذا يرجع JSON
                        payload.base64 = document.getElementById('base64-input').value;
                        payload.fileName = document.getElementById('base64-file-name').value;
                        isFileOperation = false; 
                        break;
                }
                
                // تحديد نوع الطلب (GET لـ health، POST للباقي)
                const method = (endpoint === 'health') ? 'GET' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    // إرسال body فقط مع طلبات POST
                    body: (method === 'POST') ? JSON.stringify(payload) : null,
                });
                
                // --- معالجة استجابات ملفات PDF (Stream) ---
                if (isFileOperation) {
                    if (!response.ok) {
                        let errorData = {};
                        try {
                            errorData = await response.json();
                        } catch (e) {
                            errorData = { error: `HTTP Error: ${response.status} ${response.statusText}`, details: 'Check console for network details.' };
                        }
                        displayResponse(endpoint, errorData, true);
                        return;
                    }
                    
                    const info = {
                        supabaseUrl: response.headers.get('X-Supabase-Url'),
                        ...JSON.parse(response.headers.get('X-PDF-Info') || '{}')
                    };
                    
                    const blob = await response.blob();
                    const message = downloadFile(blob, filename, info);
                    displayResponse(endpoint, message, false);
                    return;
                } 
                
                // --- معالجة استجابات JSON ---
                const data = await response.json();

                if (!response.ok || data.ok === false) {
                    displayResponse(endpoint, data, true);
                } else {
                    displayResponse(endpoint, data, false);
                }

            } catch (error) {
                console.error(`Error in ${endpoint}:`, error);
                displayResponse(endpoint, { error: `فشل الاتصال بالسيرفر: ${SERVER_URL}` }, true);
            }
        }
    </script>
</body>
  </html>
